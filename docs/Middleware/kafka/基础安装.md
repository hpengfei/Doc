## 启动

### 网络配置

```
# curl -L git.io/weave -o /usr/local/bin/weave
# chmod a+x /usr/local/bin/weave
# weave launch
# eval $(weave env)
```

注意：第一个主机执行 `weave launch`，后面每多一台主机添加到weave中需要执行 `weave launch $host1 ... $hostN` 。在新建docker容器之前必须执行 `eval $(weave env)` 命令。

### 启动kafka

```
# tree np-kafka-01
np-kafka-01
├── d
│   └── kafka
│       ├── config
│       │   ├── connect-console-sink.properties
│       │   ├── connect-console-source.properties
│       │   ├── connect-distributed.properties
│       │   ├── connect-file-sink.properties
│       │   ├── connect-file-source.properties
│       │   ├── connect-log4j.properties
│       │   ├── connect-mirror-maker.properties
│       │   ├── connect-standalone.properties
│       │   ├── consumer.properties
│       │   ├── log4j.properties
│       │   ├── producer.properties
│       │   ├── server.properties
│       │   ├── tools-log4j.properties
│       │   ├── trogdor.conf
│       │   └── zookeeper.properties
│       └── logs
└── start.sh
# cat np-kafka-01/start.sh
#!/bin/bash
if [[ $# == 0 ]]; then
        echo "会启动一套系统"
        echo "格式:"
        echo "          $0 192.168.2.100: 5000"
        echo "      容器名为当前目录名"
else
        C_HOSTIP=$1
        PORTSTART=$2
        DIR_NAME=$(pwd)
        C_NAME=$(basename ${DIR_NAME})
        sudo chmod g+rwx -R $(pwd)/d
        sudo chgrp 0 -R $(pwd)/d
        eval $(weave env)
        docker run -t -d -i --name ${C_NAME} --hostname ${C_NAME}.weave.local \
                --privileged \
                --restart=unless-stopped \
                --ulimit nofile=262144:262144 \
                --ulimit memlock=-1:-1 \
                --cpus 1 \
                --memory 2G \
                --env KAFKA_HEAP_OPTS=" -Xmx2048m -Xms2048m" \
                --env KAFKA_ZOOKEEPER_CONNECT=np-zk-01:2181,np-zk-02:2181,np-zk-03:2181 \
                --env KAFKA_ADVERTISED_HOST_NAME=${C_NAME} \
                --env KAFKA_ADVERTISED_PORT=9092 \
                --env KAFKA_BROKER_ID=1 \
                --env KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=${C_NAME} -Dcom.sun.management.jmxremote.rmi.port=19999" \
                --env JMX_PORT=19999 \
                --env KAFKA_LOG_DIRS=/opt/kafka/logs \
                -v $(pwd)/d/kafka/config:/opt/kafka/config \
                -v $(pwd)/d/kafka/logs:/opt/kafka/logs \
                -p ${C_HOSTIP}19092:9092 \
                -p ${C_HOSTIP}19999:19999 \
                wurstmeister/kafka:2.13-2.7.0
         eval $(weave env --restore)
fi
# egrep -v "^$|^#" np-kafka-01/d/kafka/config/server.properties
broker.id=1                        # 需要修改
acks=all
auto.create.topics.enable=false
default.replication.factor=3
min.insync.replicas=2
enable.auto.commit=false
listeners=PLAINTEXT://0.0.0.0:9092 # 需要修改
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/opt/kafka/logs # 需要修改
num.partitions=3         # 需要修改
num.recovery.threads.per.data.dir=1
offsets.topic.replication.factor=3
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
log.retention.hours=168
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
zookeeper.connect=np-zk-01:2181,np-zk-02:2181,np-zk-03:2181
zookeeper.connection.timeout.ms=18000
group.initial.rebalance.delay.ms=0
advertised.port=9092
advertised.host.name=np-kafka-01
port=9092
```

```
# tree np-kafka-02/
np-kafka-02/
├── d
│   └── kafka
│       ├── config
│       │   ├── connect-console-sink.properties
│       │   ├── connect-console-source.properties
│       │   ├── connect-distributed.properties
│       │   ├── connect-file-sink.properties
│       │   ├── connect-file-source.properties
│       │   ├── connect-log4j.properties
│       │   ├── connect-mirror-maker.properties
│       │   ├── connect-standalone.properties
│       │   ├── consumer.properties
│       │   ├── log4j.properties
│       │   ├── producer.properties
│       │   ├── server.properties
│       │   ├── tools-log4j.properties
│       │   ├── trogdor.conf
│       │   └── zookeeper.properties
│       └── logs
└── start.sh
# cat np-kafka-02/start.sh
#!/bin/bash
if [[ $# == 0 ]]; then
        echo "会启动一套系统"
        echo "格式:"
        echo "          $0 192.168.2.100: 5000"
        echo "      容器名为当前目录名"
else
        C_HOSTIP=$1
        PORTSTART=$2
        DIR_NAME=$(pwd)
        C_NAME=$(basename ${DIR_NAME})
        sudo chmod g+rwx -R $(pwd)/d
        sudo chgrp 0 -R $(pwd)/d
        eval $(weave env)
        docker run -t -d -i --name ${C_NAME} --hostname ${C_NAME}.weave.local \
                --privileged \
                --restart=unless-stopped \
                --ulimit nofile=262144:262144 \
                --ulimit memlock=-1:-1 \
                --cpus 1 \
                --memory 2G \
                --env KAFKA_HEAP_OPTS=" -Xmx2048m -Xms2048m" \
                --env KAFKA_ZOOKEEPER_CONNECT=np-zk-01:2181,np-zk-02:2181,np-zk-03:2181 \
                --env KAFKA_ADVERTISED_HOST_NAME=${C_NAME} \
                --env KAFKA_ADVERTISED_PORT=9092 \
                --env KAFKA_BROKER_ID=2 \
                --env KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=${C_NAME} -Dcom.sun.management.jmxremote.rmi.port=29999" \
                --env JMX_PORT=29999 \
                --env KAFKA_LOG_DIRS=/opt/kafka/logs \
                -v $(pwd)/d/kafka/config:/opt/kafka/config \
                -v $(pwd)/d/kafka/logs:/opt/kafka/logs \
                -p ${C_HOSTIP}29092:9092 \
                -p ${C_HOSTIP}29999:29999 \
                wurstmeister/kafka:2.13-2.7.0
        eval $(weave env --restore)
fi
# egrep -v "^$|^#" np-kafka-02/d/kafka/config/server.properties
broker.id=2                         # 需要修改
acks=all
auto.create.topics.enable=false
default.replication.factor=3
min.insync.replicas=2
enable.auto.commit=false
listeners=PLAINTEXT://0.0.0.0:9092  # 需要修改
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/opt/kafka/logs  # 需要修改
num.partitions=3          # 需要修改
num.recovery.threads.per.data.dir=1
offsets.topic.replication.factor=3
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
log.retention.hours=168
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
zookeeper.connect=np-zk-01:2181,np-zk-02:2181,np-zk-03:2181
zookeeper.connection.timeout.ms=18000
group.initial.rebalance.delay.ms=0
advertised.port=9092
advertised.host.name=np-kafka-02
port=9092
```

```
# tree np-kafka-03/
np-kafka-03/
├── d
│   └── kafka
│       ├── config
│       │   ├── connect-console-sink.properties
│       │   ├── connect-console-source.properties
│       │   ├── connect-distributed.properties
│       │   ├── connect-file-sink.properties
│       │   ├── connect-file-source.properties
│       │   ├── connect-log4j.properties
│       │   ├── connect-mirror-maker.properties
│       │   ├── connect-standalone.properties
│       │   ├── consumer.properties
│       │   ├── log4j.properties
│       │   ├── producer.properties
│       │   ├── server.properties
│       │   ├── tools-log4j.properties
│       │   ├── trogdor.conf
│       │   └── zookeeper.properties
│       └── logs
└── start.sh
# cat np-kafka-03/start.sh
#!/bin/bash
if [[ $# == 0 ]]; then
        echo "会启动一套系统"
        echo "格式:"
        echo "          $0 192.168.2.100: 5000"
        echo "      容器名为当前目录名"
else
        C_HOSTIP=$1
        PORTSTART=$2
        DIR_NAME=$(pwd)
        C_NAME=$(basename ${DIR_NAME})
        sudo chmod g+rwx -R $(pwd)/d
        sudo chgrp 0 -R $(pwd)/d
        eval $(weave env)
        docker run -t -d -i --name ${C_NAME} --hostname ${C_NAME}.weave.local \
                --privileged \
                --restart=unless-stopped \
                --ulimit nofile=262144:262144 \
                --ulimit memlock=-1:-1 \
                --cpus 1 \
                --memory 2G \
                --env KAFKA_HEAP_OPTS=" -Xmx2048m -Xms2048m" \
                --env KAFKA_ZOOKEEPER_CONNECT=np-zk-01:2181,np-zk-02:2181,np-zk-03:2181 \
                --env KAFKA_ADVERTISED_HOST_NAME=${C_NAME} \
                --env KAFKA_ADVERTISED_PORT=9092 \
                --env KAFKA_BROKER_ID=3 \
                --env KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=${C_NAME} -Dcom.sun.management.jmxremote.rmi.port=39999" \
                --env JMX_PORT=39999 \
                --env KAFKA_LOG_DIRS=/opt/kafka/logs \
                -v $(pwd)/d/kafka/config:/opt/kafka/config \
                -v $(pwd)/d/kafka/logs:/opt/kafka/logs \
                -p ${C_HOSTIP}39092:9092 \
                -p ${C_HOSTIP}39999:39999 \
                wurstmeister/kafka:2.13-2.7.0
         eval $(weave env --restore)
fi
# egrep -v "^$|^#" np-kafka-03/d/kafka/config/server.properties
broker.id=3                         # 需要修改
acks=all
auto.create.topics.enable=false
default.replication.factor=3
min.insync.replicas=2
enable.auto.commit=false
listeners=PLAINTEXT://0.0.0.0:9092  # 需要修改
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/opt/kafka/logs  # 需要修改
num.partitions=3          # 需要修改
num.recovery.threads.per.data.dir=1
offsets.topic.replication.factor=3
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
log.retention.hours=168
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
zookeeper.connect=np-zk-01:2181,np-zk-02:2181,np-zk-03:2181
zookeeper.connection.timeout.ms=18000
group.initial.rebalance.delay.ms=0
advertised.port=9092
advertised.host.name=np-kafka-03
port=9092
```

## 验证

### topic

```
# 创建
# ./kafka-topics.sh --create --zookeeper 10.10.10.232:12181,10.10.10.233:22181,10.10.10.234:32181 --replication-factor 3 --partitions 3 --topic Test
# 列出
# ./kafka-topics.sh --list --zookeeper 10.10.10.232:12181,10.10.10.233:22181,10.10.10.234:32181
# 查看详情
# ./kafka-topics.sh --describe --zookeeper 10.10.10.232:12181,10.10.10.233:22181,10.10.10.234:32181 --topic Test
# 删除 配置文件中delete.topic.enable=true才可删除topic
# ./kafka-topics.sh --delete --zookeeper 10.10.10.232:12181,10.10.10.233:22181,10.10.10.234:32181 --topic Test
```

### 生产者消费者验证

```
# 生产者发送消息
# ./kafka-console-producer.sh --bootstrap-server 10.10.10.232:9092,10.10.10.233:9092,10.10.10.234:9092 --topic Test
# 消费者接收消息
# ./kafka-console-consumer.sh --bootstrap-server=10.10.10.232:9092,10.10.10.233:9092,10.10.10.234:9092 --topic Test --from-beginning
```





